---
title: "SummativeAssessment"
author: "Kexin Wu"
date: "23/12/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
```

## Section A (30 marks)

In this part of your assessment you will perform a data wrangling task with some finance data.

Note that clarity is highly important. Be careful to make sure you clearly explain each step in your answer. You should also include comments within your code. In addition, make the structure of your answer clear through the use of headings. You should also make sure your code is clean by making careful use of Tidyverse methods.*

------------

### A.1

Begin by downloading the csv file available within the Assessment section within Blackboard entitled “finance_data_EMATM0061”.

**(Q)** Next load the “finance_data_EMATM0061” csv file into R data frame called “finance_data_original”.

**(A)**
```{r}
folder_name <- "/Users/wukexin/Desktop/SCEM/final_assessment"
file_name <- "finance_data_EMATM0061"

finance_data_original <- read.csv(paste0(folder_name, "/", file_name, ".csv"))
```

**(Q)** How many rows and how many columns does this data frame have?

**(A)**
```{r}
finance_data_original %>% nrow()
finance_data_original %>% ncol()
```
The finance_data_original has 1051 rows and 30 columns.

-----------

### A.2

**(Q)** Generate a new data frame called “finance_data” which is a subset of the “finance_data_original” data frame with the same number of rows, but only six columns:


* The first column should be called “state_year_code” and correspond to the “state_year_code” column in the csv.

* The second column should be called “education_expenditure” and should correspond to the “Details.Education.Education.Total” column in the csv.

*  The third column should be called “health_expenditure” and should correspond to the “Details.Health.Health.Total.Expenditure” column in the csv.

* The fourth column should be called “transport_expenditure” and should correspond to the “Details.Transportation.Highways.Highways.Total.Expenditure” column in the csv.

* The fifth column should be called “totals_revenue” and should correspond to the “Totals.Revenue” column in the csv.

* The sixth column should be called “totals_expenditure” and should correspond to the “Totals.Expenditure” column in the csv.

**(A)**
```{r}
finance_data <- finance_data_original %>% 
  select(state_year_code = state_year_code,
         education_expenditure = Details.Education.Education.Total,
         health_expenditure = Details.Health.Health.Total.Expenditure,
         transport_expenditure = Details.Transportation.Highways.Highways.Total.Expenditure,
         totals_revenue = Totals.Revenue,
         totals_expenditure = Totals.Expenditure)
```

**(Q)** Display a subset of the “finance_data” dataframe consisting of the first five rows and first three columns (“state_year_code”,“education_expenditure”,“health_expenditure”).

**(A)**
```{r}
finance_data %>% head(5)
```

----------

### A.3

**(Q)** Create a new column within the “finance_data” data frame called “totals_savings” which is equal to the difference between revenue and the expenditure ie. the elements of the “totals_savings” column are equal to elements within the “totals_revenue” minus the element within the “totals_expenditure” column, for each row.

Your “finance_data” data frame should now have seven columns.

**(A)**
```{r}
finance_data <- finance_data %>% 
  mutate(totals_savings = totals_revenue - totals_expenditure)
finance_data %>% ncol()
```

**(Q)** Display a subset of the “finance_data” dataframe consisting of the first three rows and the four columns “state_year_code”,“totals_revenue”,“totals_expenditure”,“totals_savings”.

**(A)**
```{r}
finance_data %>% 
  select(state_year_code, totals_revenue, totals_expenditure, totals_savings) %>%
  head(3)
```

------------

### A.4

**(Q)** The “state_year_code” column within your “finance_data” data frame contains both a state and a year in character format connected via a double underscore.

Divide the “state_year_code” column into two separate columns, a “state” column and a “year” column which replace the original “state_year_code” column.

Your “finance_data” data frame should now have eight columns.

**(A)**
```{r}
finance_data <- finance_data %>%
  separate(state_year_code, into = c("state", "year"), sep = "__", convert =TRUE)

finance_data %>% ncol()
finance_data %>% head(5)
```

**(Q)** Convert the states so that they appear with the first letter of each word in upper case and the remainder in lower case eg. we should see “New Hampshire” rather than “NEW HAMPSHIRE”. You may wish to use the function str_to_title().

**(A)**
```{r}
finance_data <- finance_data %>% 
  mutate(state_title = str_to_title(state)) %>%
  select(-state) %>%
  rename(state = state_title)

```

**(Q)** Display a subset of the “finance_data” data frame consisting of the first three rows and the five columns “state”, “year”,“totals_revenue”,“totals_expenditure”,“totals_savings”.

**(A)**
```{r}
finance_data %>% 
  select(state, year, totals_revenue, totals_expenditure, totals_savings) %>%
  head(3)
```

-----------

-----------

### A.5

**(Q)** Generate a plot which displays the total revenue (“total_revenue”) as function of the year (“year”) for the following four states: Louisiana, Montana, Mississippi and Kentucky.

Display the revenue in terms of millions of dollars.

**(A)**
```{r}
finance_data %>% 
  filter(state %in% c("Louisiana", "Montana", "Mississippi", "Kentucky")) %>% 
  ggplot(aes(x = year, y = totals_revenue / 1000000, color = state,
                         linetype = state)) + 
  geom_smooth() + xlab("Year") + ylab("Revenue(million $)")
```

-----------

### A.6

**(Q)** Create a function called get_decade() which takes as input a number and rounds that number down to the nearest multiple of 10. For example, the numbers 20, 21, 22, . . . , 29 would all be mapped to the output 20.

**(A)**
```{r}
get_decade <- function(x){
  return((x %/% 10) * 10)
}
```

**(Q)** Use your get_decade() function to add a new column to the “finance_data” data frame called “decade” which should give the decade corresponding to the year column. For example, the decade of the years 1990,1991,. . . ,1998,1999 is 1990.

Your “finance_data” data frame should now have nine columns.

**(A)**
```{r}
finance_data <- finance_data %>%
  mutate(decade = map_dbl(year, get_decade))

finance_data %>% ncol()
```

**(Q)** Which three states had the highest mean-average savings (“totals_savings”) over the decade starting 2000? 

Note:

* When computing the average you should disregard any years in which the information is not available i.e. the average should be taken only over those years for which the savings entry is not an “NA”.

* You should aim to use a succinct Tidyverse type solution.

**(A)**
```{r}
finance_data %>% 
  select(state, decade, totals_savings) %>% 
  group_by(state, decade) %>% 
  summarise(average_savings = mean(totals_savings, na.rm = TRUE)) %>%
  filter(decade == 2000) %>%
  arrange(desc(average_savings)) %>%
  head(3)
```

The highest mean_average sacings("totals_savings") over the decade starting 2000 are Texas, Ohio and California.

--------------

### A.7

**(Q)** Next generate a summary data frame from the “finance_data” data frame called “alaska_summary” with the following properties:

Your summary data frame should correspond to rows associated with the state of Alaska. Your summary data frame should have three rows each corresponding to a decade from 1990 through to 2010 inclusive. Your data frame should also have seven columns:

(a\) “decade” – the decade (1990, 2000, 2010)

(b\) “ed_mn” – the mean of the education expenditure in Alaska for the corresponding decade 

(c\) “ed_md” – the median of the education expenditure in Alaska for the corresponding decade 

(d\) “he_mn” – the mean of the health expenditure in Alaska for the corresponding decade

(e\) “he_md” – the median of the health expenditure in Alaska for the corresponding decade

(f\) “tr_mn” – the mean of the transport expenditure in Alaska for the corresponding decade 

(g\) “tr_md” – the median of the transport expenditure in Alaska for the corresponding decade

You should use Tidyverse methods to create your “alaska_summary” data frame. Display the “alaska_summary” data frame.

**(A)**
```{r}
alaska_summary <- finance_data %>%
  filter(state == "Alaska") %>%
  group_by(decade) %>%
  summarise(across(starts_with(c("education_expenditure", "health_expenditure", "transport_expenditure")), list(md = median, mn = mean), .names = "{substring(.col, 1, 2)}_{.fn}", na.rm = TRUE))

alaska_summary
```

---------------

### A.8

**(Q)** Create a function called impute_by_median which takes as input a vector numerical values, which may include some “NA”s, and replaces any missing values (“NA”s) with the median over the vector.

**(A)**
```{r}
impute_by_median <- function(x){
  mu = median(x, na.rm = TRUE) # first compute the median of x
  impute_f <- function(z){ # coordinate-wise imputation
    if(is.na(z)){
      return(mu) # if z is na replace with median
    } else{
      return(z) # otherwise leave in place
    }
  }
  return(map_dbl(x, impute_f))
}
```

**(Q)** *Next generate a subset of your “finance_data” data frame called “idaho_2000” which contains all those rows in which the state column takes the value “Idaho” and the “decade” column takes the value “2000” and includes the columns “year”, “education_expenditure”, “health_expenditure”, “transport_expenditure”, “totals_revenue”, “totals_expenditure”, “totals_savings” (i.e. all columns except “state” and “decade”).

**(A)**
```{r}
idaho_2000 <- finance_data %>%
  filter(state == "Idaho") %>%
  filter(decade == 2000) %>% 
  select(year, education_expenditure, health_expenditure, transport_expenditure, totals_revenue, totals_expenditure, totals_savings)

idaho_2000 %>% head(5)
```

**(Q)** Now apply your “impute_by_median” data frame to create a new data frame called “idaho_2000_imputed” which is based on your existing “idaho_2000” data frame but with any missing values replaced with the corresponding me- dian value for the that column. That is, for each of the columns “education_expenditure”, “health_expenditure”, “transport_expenditure”, “totals_revenue”, “totals_expenditure”, “totals_savings” any missing values (given by “NA”) are replaced with the median over that column.

Display a subset of your “idaho_2000_imputed” data frame consisting of the first five rows and the four columns “year”, “health_expenditure”, “education_expenditure” and “totals_savings”.

**(A)**
```{r}
idaho_2000 <- idaho_2000 %>%
  summarise(across(everything(), impute_by_median))

idaho_2000 %>% 
  select(year, health_expenditure, education_expenditure, totals_savings) %>%
  head(5)
```

------------

## Section B (30 marks)

### B.1

In this question we consider a security system at a factory. A sensor is designed to make a sound if a person walks within one metre of the gate. However, the sensor is not perfectly reliable: It sometimes makes a sound when there is no one present, and sometimes fails to make a sound when someone is present.

For simplicity we will view the passage of time as being broken down into a series of phases lasting exactly one minute. For each minute, we let $p_0$ denote the conditional probability that the sensor makes a sound if there is no person within one metre of the gate, during that minute. Moreover, for each minute, we let $p_1$ denote the conditional probability that the sensor makes a sound at least once, if there is at least one person present, during that minute. Suppose also that the probability that at least one person walks within one metre of the gate over any given minute is $q$. Again, for simplicity, we assume that $p_0$, $p_1$, $q \in [0, 1]$ are all constant. Let $\phi$ denote the conditional probability that at least one person has passed within one metre of the gate during the current minute, given that the alarm has made a sound during that minute.

**(a.Q)**  Write a function called c_prob_person_given_alarm which gives $\phi$ as a function of $p_0$, $p_1$ and $q$.

**(a.A)**Let A be the event that the sensor makes a sound, and B be the event that at least one person is within one metre of the gate during that minute.

So we have $p_0 = \mathbb{P}(A \mid B^C)$, $p_1 = \mathbb{P}(A \mid B)$, $q = \mathbb{P}(B)$, and $\phi = \mathbb{P}(B \mid A)$.

First, we compute the $\mathbb{P}(A)$:
$$
\mathbb{P}(A) = \mathbb{P}(A \cap B) + \mathbb{P}(A \cap B^C) = \mathbb{P}(A \mid B) \cdot \mathbb{P}(B) + \mathbb{P}(A \mid B^C) \cdot \mathbb{P}(B^C) = p_1 \cdot q + p_0 \cdot (1-q)
$$

Then, from the Bayes theorm, we have 
$$
\phi = \mathbb{P}(B \mid A) = \frac{\mathbb{P}(B) \cdot \mathbb{P}(A \mid B)}{\mathbb{P}(A)} = \frac{q \cdot p_1}{p_1 \cdot q + p_0 \cdot (1 - q)}
$$


```{r}
c_prob_person_given_alarm <- function(p0, p1, q){
  phi = q * p1 / (p1 * q + p0 * (1 - q))
  return(phi)
}
```

**(b.Q)** Consider a setting in which $p_0 = 0.05$, $p_1 = 0.95$ and $q = 0.1$. In this case, what is $\phi$?

**(b.A)**
```{r}
p0 <- 0.05
p1 <- 0.95
q <- 0.1
phi <- c_prob_person_given_alarm(p0, p1, q)
phi
```

**(c.Q)** Next consider a setting in which $p_0 = 0.05$, $p_1 = 0.95$ and generate a plot which shows $\phi$ as we vary $q$. That is, you should display a curve which has $q$ along the horizontal axis and the corresponding value of $\phi$ along the vertical axis.

**(c.A)**
```{r}
library(latex2exp)

p0 <- 0.05
p1 <- 0.95

phi <- data.frame(q = seq(0, 1, 0.0001))
phi %>%
  mutate(phi = c_prob_person_given_alarm(p0, p1, q)) %>%
  ggplot(mapping = aes(x = q, y = phi)) + 
  geom_line() +
  theme_bw() +
  xlab("q") + 
  ylab(TeX("$\\phi$"))
```

----------------

### B.2

Suppose that $\alpha, \beta, \gamma \in [0, 1]$ with $\alpha + \beta + \gamma \leq 1$ and let $X$ be a discrete random variable with with distribution supported on $\{0, 1, 2, 5\}$. Suppose that $\mathbb{P}(X = 1) = \alpha$, $\mathbb{P}(X = 2) = \beta$, $\mathbb{P}(X = 5) = \gamma$ and $\mathbb{P}(X \notin \{0, 1, 2, 5\}) = 0$.

**(a.Q)** What is the probability mass function $p_X: \mathbb{R} \to [0, 1]$ for $X$?

**(a.A)**
The probability mass function $p_X: \mathbb{R} \to [0, 1]$ for $X$ is:
$$
p_X(x) = \begin{cases}
1- \alpha - \beta - \gamma & if \quad x = 0 \\
\alpha & if \quad x = 1 \\
\beta & if \quad x = 2 \\
\gamma & if \quad x = 5
\end{cases} 
$$


**(b.Q)** Give an expression for the expectation of $X$ in terms of $\alpha, \beta, \gamma$.

**(b.A)** The expression for the expectation of $X$ is:
$$
\mathbb{E}(X) = (1 - \alpha - \beta - \gamma) \cdot 0 + \alpha \cdot 1 + \beta \cdot 2 + \gamma \cdot 5 = \alpha + 2\beta + 5\gamma
$$

**(c.Q)** Give an expression for the population variance of $X$ in terms of $\alpha, \beta, \gamma$.

**(c.A)** The expression for the population variance of $X$ is:
$$
Var(X) = \mathbb{E}[X^2] - \mathbb{E}(X)^2 = (\alpha + 4\beta + 25\gamma) - (\alpha + 2\beta + 5\gamma)^2 = \alpha + 4\beta + 25\gamma -\alpha^2 - 4\beta^2 - 25\gamma^2 - 4\alpha \beta - 10\alpha \gamma - 20\beta \gamma
$$

----------

Suppose $X_1, . . . , X_n$ is a sample consisting of independent and identically distributed random variables with $\mathbb{P}(X_i = 1) = \alpha$, $\mathbb{P}(X_i = 2) = \beta$, $\mathbb{P}(X_i = 5) = \gamma$ and $\mathbb{P}(X_i \notin \{0, 1, 2, 5\})=0$ for $i = 1,...,n$. Let $\overline{X} := \frac{1}{n} \sum_{i = 1}^{n}X_i$ be the sample mean.

**(d.Q)** Give an expression for the expectation of the random variable $\overline{X}$ in terms of $\alpha, \beta, \gamma$.

**(d.A)** The expectation of the random variable $\overline{X}$ is:
$$
\mathbb{E}(\overline{X}) = \alpha + 2\beta + 5\gamma
$$

**(e.Q)** Give an expression for the population variance of the random variable $\overline{X}$ in terms of $\alpha, \beta, \gamma, n$.

**(e.A)** The population variance of the random variable $\overline{X}$ is:
$$
Var(\overline{X}) = \alpha + 4\beta + 25\gamma -\alpha^2 - 4\beta^2 - 25\gamma^2 - 4\alpha \beta - 10\alpha \gamma - 20\beta \gamma
$$

**(f.Q)** Create a function called sample_X_0125() which takes as inputs $\alpha, \beta, \gamma$ and $n$ and outputs a sample $X_1,...,X_n$ of independent copies of $X$ where $\mathbb{P}(X = 1) = \alpha$, $\mathbb{P}(X = 2) = \beta$, $\mathbb{P}(X = 5) = \gamma$ and $P(X \notin \{0,1,2,5\}) = 0$.

**(f.A)**
```{r}
sample_X_0125 <- function(alpha, beta, gamma, n){
  sample_X <- data.frame(U = runif(n)) %>%
    mutate(X = case_when(
      (0 <= U) & (U < alpha) ~ 1,
      (alpha <= U) & (U < alpha + beta) ~ 2,
      (alpha + beta <= U) & (U < alpha + beta + gamma) ~ 5,
      (alpha + beta + gamma <= U) & (U <= 1) ~ 0)) %>%
  pull(X)
}
```

**(g.Q)** Suppose that $\alpha = 0.1$, $\beta = 0.2$, $\gamma = 0.3$. Use your function to generate a sample of size $n = 100000$ consisting of independent copies of $X$ where $\mathbb{P}(X = 1) = \alpha$, $\mathbb{P}(X = 2) = \beta$, $\mathbb{P}(X = 5) = \gamma$ and $\mathbb{P} (X \notin \{0, 1, 2, 5\}) = 0$. What value do you observe for $X$? What value do you observe for the sample variance? Is this the type of result you expect? Explain your answer.

**(g.A)** 
```{r}
n <- 100000
alpha <- 0.1
beta <- 0.2
gamma <- 0.3

sample_X <- sample_X_0125(alpha, beta, gamma, n)
mean(sample_X)
var(sample_X)
```

Based on the answer of question in section d and f, we have 
$$
\mathbb{E}(X) = \alpha + 2\beta + 5\gamma = 2
$$ 
and 
$$
Var(X) = \alpha + 4\beta + 25\gamma -\alpha^2 - 4\beta^2 - 25\gamma^2 - 4\alpha \beta - 10\alpha \gamma - 20\beta \gamma = 4.4
$$
Hence, the $\overline{X}$ is close to the expectation of $X$ and the sample variance is close to the population variance.

**(h.Q)** Once again, take $\alpha = 0.1$, $\beta = 0.2$, $\gamma = 0.3$. Conduct a simulation study to explore the behavior of the sample mean. Your study should involve $10000$ trials. In each trial, you should set $n = 100$ and create a sample $X_1,...,X_n$ of independent and identically distributed random variables with $\mathbb{P}(X = 1) = \alpha$, $\mathbb{P}(X = 2) = \beta$, $\mathbb{P}(X = 5) = \gamma$ and $\mathbb{P} (X \notin \{0, 1, 2, 5\}) = 0$. for $i = 1,...,n$. For each of the $10000$ trials, compute the corresponding sample mean $\overline{X}$ based on $X_1, . . . , X_n$.

**(h.A)** 
```{r}
set.seed(0)
num_trials <- 10000
alpha <- 0.1
beta <- 0.2
gamma <- 0.3
n <- 100

simulation_X <- data.frame()
```



